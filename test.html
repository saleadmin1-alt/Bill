<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>X√°c nh·∫≠n ƒë∆°n h√†ng / H√≥a ƒë∆°n</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; margin-bottom: 5px; }
    .store-info { text-align: center; margin-bottom: 10px; }
    .barcode-box { text-align: center; margin: 10px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #333; padding: 6px; text-align: center; }
    th { background: #eee; }
    .total-row td { font-weight: bold; }
    .btn-box { text-align: center; margin: 10px 0; }
    .btn {
      display: inline-block;
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn:hover { background: #0056b3; }
    .qr-box { text-align: center; margin-top: 15px; }
    .qr-box img { width: 220px; height: 220px; }
    @media print {
      .btn-box { display: none; }
    }
  </style>
</head>
<body>
  <div class="store-info">
    <div id="storeName"><b></b></div>
    <div id="storeAddress"></div>
    <div id="storePhone"></div>
  </div>

  <h2>X√ÅC NH·∫¨N ƒê∆†N H√ÄNG</h2>

  <div class="barcode-box">
    <img id="barcode" alt="M√£ v·∫°ch ƒë∆°n h√†ng">
  </div>
  <div class="center">M√£ ƒë∆°n h√†ng: <span id="invoiceId"></span></div>
  <div class="center">Ng√†y t·∫°o ƒë∆°n: <span id="orderDate"></span></div>

  <div class="btn-box">
    <button class="btn" onclick="window.print()">üñ® In h√≥a ƒë∆°n</button>
    <button class="btn" onclick="exportExcelFull()">üì• Xu·∫•t Excel</button>
  </div>

  <div id="info">
    <p><b>Kh√°ch h√†ng:</b> <span id="custName"></span></p>
    <p><b>ƒê·ªãa ch·ªâ:</b> <span id="custAddress"></span></p>
    <p><b>S·ªë ti·ªÅn thanh to√°n:</b> <span id="custPayment"></span> VND</p>
  </div>

  <table id="billTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>SKU</th>
        <th>S·∫£n ph·∫©m</th>
        <th>ƒê∆°n v·ªã</th>
        <th>S·ªë l∆∞·ª£ng</th>
        <th>ƒê∆°n gi√°</th>
        <th>Th√†nh ti·ªÅn</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="total-row">
        <td colspan="4">T·ªîNG C·ªòNG</td>
        <td id="tongSlCell">0</td>
        <td></td>
        <td id="tongTienCell">0</td>
      </tr>
    </tfoot>
  </table>

  <div id="qrcode" class="qr-box"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);

    // L·∫•y th√¥ng tin t·ª´ URL
    const storeName = params.get("tencuahang") ? decodeURIComponent(params.get("tencuahang")) : "";
    const storeAddress = params.get("diachicuahang") ? decodeURIComponent(params.get("diachicuahang")) : "";
    const storePhone = params.get("dienthoaicuahang") ? decodeURIComponent(params.get("dienthoaicuahang")) : "";
    const id = params.get("id") ? decodeURIComponent(params.get("id")) : "";
    const ten = params.get("ten") ? decodeURIComponent(params.get("ten")) : "";
    const diachi = params.get("diachi") ? decodeURIComponent(params.get("diachi")) : "";
    const thanhtoan = params.get("thanhtoan") ? decodeURIComponent(params.get("thanhtoan")) : "0";
    const bankCode = params.get("bank") ? decodeURIComponent(params.get("bank")) : "";
    const accountNumber = params.get("stk") ? decodeURIComponent(params.get("stk")) : "";
    const accountName = params.get("chutk") ? decodeURIComponent(params.get("chutk")) : "";

    // Hi·ªÉn th·ªã th√¥ng tin l√™n trang
    document.getElementById("storeName").innerText = storeName;
    document.getElementById("storeAddress").innerText = "ƒê·ªãa ch·ªâ: " + storeAddress;
    document.getElementById("storePhone").innerText = "SƒêT: " + storePhone;
    document.getElementById("invoiceId").innerText = id;
    document.getElementById("custName").innerText = ten;
    document.getElementById("custAddress").innerText = diachi;
    document.getElementById("custPayment").innerText = Number(thanhtoan).toLocaleString("vi-VN");
    document.getElementById("orderDate").innerText = new Date().toLocaleDateString("vi-VN");

    // M√£ v·∫°ch
    if (id) {
      document.getElementById("barcode").src =
        "https://barcode.tec-it.com/barcode.ashx?code=Code128&translate-esc=on&data=" + encodeURIComponent(id);
    }

    // T·∫°o b·∫£ng s·∫£n ph·∫©m
    const dataStr = params.get("data") ? decodeURIComponent(params.get("data")) : "";
    const rows = dataStr.split("_n_");
    const tbody = document.querySelector("#billTable tbody");
    let tongTien = 0;
    let tongSL = 0;

    rows.forEach((r, idx) => {
      if (r.trim()) {
        const cols = r.split("|");
        // cols thi·∫øt k·∫ø: [SKU, T√™n s·∫£n ph·∫©m, ƒêVT, S·ªë l∆∞·ª£ng, ƒê∆°n gi√°, Th√†nh ti·ªÅn] ‚Äî t√πy b·∫°n truy·ªÅn d·ªØ li·ªáu
        // Theo link c·ªßa b·∫°n, data = "TS_E57C2940|B·∫øp ƒëi·ªán t·ª≠-TS_E57C2940|C√°i|1|167|167"
        const tr = document.createElement("tr");

        const tdStt = document.createElement("td");
        tdStt.innerText = idx + 1;
        tr.appendChild(tdStt);

        // SKU
        const tdSKU = document.createElement("td");
        tdSKU.innerText = cols[0] || "";
        tr.appendChild(tdSKU);

        // T√™n s·∫£n ph·∫©m
        const tdName = document.createElement("td");
        tdName.innerText = cols[1] || "";
        tr.appendChild(tdName);

        // ƒê∆°n v·ªã
        const tdDVT = document.createElement("td");
        tdDVT.innerText = cols[2] || "";
        tr.appendChild(tdDVT);

        // S·ªë l∆∞·ª£ng
        const qty = parseFloat(cols[3]) || 0;
        const tdQty = document.createElement("td");
        tdQty.innerText = qty;
        tr.appendChild(tdQty);
        tongSL += qty;

        // ƒê∆°n gi√°
        const price = parseFloat(cols[4]) || 0;
        const tdPrice = document.createElement("td");
        tdPrice.innerText = price.toLocaleString("vi-VN");
        tr.appendChild(tdPrice);

        // Th√†nh ti·ªÅn
        const total = parseFloat(cols[5]) || (qty * price);
        const tdTotal = document.createElement("td");
        tdTotal.innerText = total.toLocaleString("vi-VN");
        tr.appendChild(tdTotal);
        tongTien += total;

        tbody.appendChild(tr);
      }
    });

    document.getElementById("tongSlCell").innerText = tongSL.toLocaleString("vi-VN");
    document.getElementById("tongTienCell").innerText = tongTien.toLocaleString("vi-VN") + " VND";

    // QR thanh to√°n (n·∫øu c·∫ßn)
    if (thanhtoan !== "0" && bankCode && accountNumber) {
      const qrUrl = `https://img.vietqr.io/image/${bankCode}-${accountNumber}-compact.jpg?amount=${thanhtoan}&addInfo=CK%20${encodeURIComponent(ten)}&accountName=${encodeURIComponent(accountName)}`;
      document.getElementById("qrcode").innerHTML = `
        <p><b>QR Code Thanh to√°n</b></p>
        <img src="${qrUrl}" alt="QR Thanh to√°n">
      `;
    }

    // H√†m xu·∫•t Excel ƒë·∫ßy ƒë·ªß
    function exportExcelFull() {
      const wb = XLSX.utils.book_new();
      const ws_data = [];

      // Header c√¥ng ty
      ws_data.push([storeName]);
      ws_data.push(["ƒê·ªãa ch·ªâ: " + storeAddress]);
      ws_data.push(["SƒêT: " + storePhone]);
      ws_data.push([]);
      // D√≤ng ti√™u ƒë·ªÅ ƒë∆°n h√†ng
      ws_data.push(["X√ÅC NH·∫¨N ƒê∆†N H√ÄNG"]);
      ws_data.push(["M√£ ƒë∆°n h√†ng:", id]);
      ws_data.push(["Ng√†y t·∫°o ƒë∆°n:", new Date().toLocaleDateString("vi-VN")]);
      ws_data.push([]);
      // Th√¥ng tin kh√°ch h√†ng
      ws_data.push(["Kh√°ch h√†ng:", ten]);
      ws_data.push(["ƒê·ªãa ch·ªâ:", diachi]);
      ws_data.push(["S·ªë ti·ªÅn thanh to√°n:", thanhtoan]);
      ws_data.push([]);
      // T√†i kho·∫£n thanh to√°n
      ws_data.push(["T√†i kho·∫£n thanh to√°n"]);
      ws_data.push(["Ng√¢n h√†ng:", bankCode]);
      ws_data.push(["S·ªë t√†i kho·∫£n:", accountNumber]);
      ws_data.push(["Ch·ªß t√†i kho·∫£n:", accountName]);
      ws_data.push([]);
      // Chi ti·∫øt s·∫£n ph·∫©m
      ws_data.push(["STT","SKU","S·∫£n ph·∫©m","ƒê∆°n v·ªã","S·ªë l∆∞·ª£ng","ƒê∆°n gi√°","Th√†nh ti·ªÅn"]);
      // d·ªØ li·ªáu s·∫£n ph·∫©m
      rows.forEach((r, idx) => {
        if (r.trim()) {
          const cols = r.split("|");
          const qty = parseFloat(cols[3]) || 0;
          const price = parseFloat(cols[4]) || 0;
          const total = parseFloat(cols[5]) || (qty * price);
          ws_data.push([
            idx + 1,
            cols[0] || "",
            cols[1] || "",
            cols[2] || "",
            qty,
            price,
            total
          ]);
        }
      });
      ws_data.push([]);
      ws_data.push(["T·ªïng s·ªë l∆∞·ª£ng:", tongSL]);
      ws_data.push(["T·ªïng th√†nh ti·ªÅn:", tongTien]);
      ws_data.push([]);

      ws_data.push(["Ng∆∞·ªùi l·∫≠p ƒë∆°n",'','Ng∆∞·ªùi nh·∫≠n','']);
      ws_data.push(["(K√Ω, h·ªç t√™n)",'','(K√Ω, h·ªç t√™n)','']);

      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      // Optionally: set column widths
      ws['!cols'] = [
        {wch:6}, // STT
        {wch:20}, // SKU
        {wch:30}, // S·∫£n ph·∫©m
        {wch:15}, // ƒê∆°n v·ªã
        {wch:12}, // S·ªë l∆∞·ª£ng
        {wch:15}, // ƒê∆°n gi√°
        {wch:15}  // Th√†nh ti·ªÅn
      ];

      XLSX.utils.book_append_sheet(wb, ws, "ƒê∆°n h√†ng");
      XLSX.writeFile(wb, `XacNhanDon_${id || Date.now()}.xlsx`);
    }

  </script>
</body>
</html>
