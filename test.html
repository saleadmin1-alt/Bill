<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
function exportExcel() {
  const wb = XLSX.utils.book_new();
  const params = new URLSearchParams(window.location.search);

  // L·∫•y params
  const storeName = params.get("tencuahang") || "C·ª≠a h√†ng ch∆∞a ƒë·∫∑t t√™n";
  const storeAddress = params.get("diachicuahang") || "";
  const storePhone = params.get("dienthoaicuahang") || "";
  const id = params.get("id") || "";
  const ten = decodeURIComponent(params.get("ten") || "");
  const diachi = decodeURIComponent(params.get("diachi") || "");
  const thanhtoan = decodeURIComponent(params.get("thanhtoan") || "0");
  const bankCode = params.get("bank") || "";
  const accountNumber = params.get("stk") || "";
  const accountName = decodeURIComponent(params.get("chutk") || "");

  // Parse s·∫£n ph·∫©m
  const data = decodeURIComponent(params.get("data") || "");
  const rows = data.split("_n_"); 
  let productRows = [["STT","SKU","S·∫¢N PH·∫®M","ƒêVT","S·ªê L∆Ø·ª¢NG","ƒê∆†N GI√Å","TH√ÄNH TI·ªÄN"]];
  rows.forEach((r, index) => {
    if (r.trim() !== "") {
      const cols = r.split("|"); 
      productRows.push([
        index+1,
        cols[0] || "",
        cols[1] || "",
        cols[2] || "",
        cols[3] || "",
        cols[4] || "",
        cols[5] || ""
      ]);
    }
  });

  // T·∫°o sheet ch√≠nh
  const wsData = [
    ["C√îNG TY TNHH / C·ª¨A H√ÄNG", storeName],
    ["ƒê·ªãa ch·ªâ", storeAddress],
    ["ƒêi·ªán tho·∫°i", storePhone],
    [],
    ["X√ÅC NH·∫¨N ƒê∆†N H√ÄNG"],
    ["M√£ ƒë∆°n h√†ng:", id],
    ["Kh√°ch h√†ng:", ten],
    ["ƒê·ªãa ch·ªâ KH:", diachi],
    ["S·ªë ti·ªÅn thanh to√°n:", Number(thanhtoan).toLocaleString("vi-VN")+" VND"],
    [],
    ["T√ÄI KHO·∫¢N THANH TO√ÅN"],
    ["Ng√¢n h√†ng", bankCode],
    ["S·ªë t√†i kho·∫£n", accountNumber],
    ["Ch·ªß t√†i kho·∫£n", accountName],
    [],
    ["CHI TI·∫æT S·∫¢N PH·∫®M:"],
    ...productRows
  ];

  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // Merge & ƒë·ªãnh d·∫°ng
  ws['!merges'] = [
    {s:{r:4,c:0}, e:{r:4,c:6}} // g·ªôp d√≤ng "X√ÅC NH·∫¨N ƒê∆†N H√ÄNG"
  ];

  // Set width c·ªôt
  ws['!cols'] = [
    {wch:5},  // STT
    {wch:15}, // SKU
    {wch:30}, // S·∫£n ph·∫©m
    {wch:10}, // ƒêVT
    {wch:12}, // S·ªë l∆∞·ª£ng
    {wch:15}, // ƒê∆°n gi√°
    {wch:18}  // Th√†nh ti·ªÅn
  ];

  XLSX.utils.book_append_sheet(wb, ws, "X√°c nh·∫≠n ƒë∆°n h√†ng");

  XLSX.writeFile(wb, "XacNhanDonHang_" + id + ".xlsx");
}
</script>

<button class="print-btn" onclick="exportExcel()">üì• Xu·∫•t Excel</button>
