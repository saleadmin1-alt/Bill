<script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>
<script>
async function exportFromTemplate() {
  // Link file template tr√™n GitHub (RAW link)
  const url = "https://raw.githubusercontent.com/saleadmin1-alt/bill-template/main/template.xlsx";

  // Load template
  const response = await fetch(url);
  const buffer = await response.arrayBuffer();

  // M·ªü workbook
  const workbook = await XlsxPopulate.fromDataAsync(buffer);
  const sheet = workbook.sheet(0);

  // L·∫•y tham s·ªë t·ª´ URL
  const params = new URLSearchParams(window.location.search);

  const storeName   = params.get("tencuahang") || "";
  const storeAddr   = params.get("diachicuahang") || "";
  const storePhone  = params.get("dienthoaicuahang") || "";
  const orderId     = params.get("id") || "";
  const customer    = params.get("ten") || "";
  const custAddr    = params.get("diachi") || "";
  const totalPay    = params.get("thanhtoan") || "0";
  const bank        = params.get("bank") || "";
  const account     = params.get("stk") || "";
  const accountName = params.get("chutk") || "";

  // Parse danh s√°ch s·∫£n ph·∫©m
  const data = decodeURIComponent(params.get("data") || "");
  const rows = data.split("_n_");

  // ---- Ghi d·ªØ li·ªáu v√†o template ----
  sheet.cell("B3").value(storeName);
  sheet.cell("B4").value(storeAddr);
  sheet.cell("B5").value(storePhone);

  sheet.cell("B7").value("M√£ ƒë∆°n h√†ng: " + orderId);
  sheet.cell("B8").value("Kh√°ch h√†ng: " + customer);
  sheet.cell("B9").value("ƒê·ªãa ch·ªâ: " + custAddr);
  sheet.cell("B10").value("Thanh to√°n: " + Number(totalPay).toLocaleString("vi-VN") + " VND");

  sheet.cell("E6").value("Ng√¢n h√†ng: " + bank);
  sheet.cell("E7").value("STK: " + account);
  sheet.cell("E8").value("Ch·ªß TK: " + accountName);

  // ƒê·ªï s·∫£n ph·∫©m v√†o b·∫£ng (gi·∫£ s·ª≠ b·∫£ng b·∫Øt ƒë·∫ßu t·ª´ d√≤ng 12)
  let startRow = 12;
  rows.forEach((r, i) => {
    if (r.trim() !== "") {
      const cols = r.split("|");
      sheet.cell("A" + (startRow + i)).value(i + 1);          // STT
      sheet.cell("B" + (startRow + i)).value(cols[0] || ""); // SKU
      sheet.cell("C" + (startRow + i)).value(cols[1] || ""); // S·∫£n ph·∫©m
      sheet.cell("D" + (startRow + i)).value(cols[2] || ""); // ƒêVT
      sheet.cell("E" + (startRow + i)).value(Number(cols[3] || 0)); // SL
      sheet.cell("F" + (startRow + i)).value(Number(cols[4] || 0)); // ƒê∆°n gi√°
      sheet.cell("G" + (startRow + i)).value(Number(cols[5] || 0)); // Th√†nh ti·ªÅn
    }
  });

  // Xu·∫•t file
  workbook.outputAsync().then(function(blob) {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "DonHang_" + orderId + ".xlsx";
    a.click();
    window.URL.revokeObjectURL(url);
  });
}
</script>

<button onclick="exportFromTemplate()">üì• Xu·∫•t Excel (gi·ªØ format)</button>
