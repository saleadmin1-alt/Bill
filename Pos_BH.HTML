<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>H√≥a ƒë∆°n b√°n h√†ng</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; margin-bottom: 2px; }
    .info { text-align: center; margin-bottom: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    table, th, td { border: 1px solid black; }
    th, td { padding: 5px; text-align: center; }
    .total-row { font-weight: bold; }
    .barcode-box, .qrcode-box { text-align: center; margin: 10px 0; }
    .footer { text-align: center; margin-top: 15px; font-style: italic; }
    .print-btn { margin: 10px 0; text-align: center; }
  </style>
</head>
<body>
  <h2 id="storeName">C·ª≠a h√†ng</h2>
  <div class="info" id="storeAddress">ƒê·ªãa ch·ªâ:</div>
  <div class="info" id="storePhone">SƒêT:</div>
  <h2>H√ìA ƒê∆†N B√ÅN H√ÄNG</h2>
  <div class="barcode-box">
    <img id="barcode" alt="Barcode">
  </div>
  <div style="display:none">M√£ Hƒê: <span id="orderId"></span></div>

  <div class="print-btn"><button onclick="window.print()">üñ® In h√≥a ƒë∆°n</button></div>

  <p><strong>Kh√°ch h√†ng:</strong> <span id="customerName"></span></p>
  <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="customerAddress"></span></p>
  <p><strong>S·ªë ti·ªÅn thanh to√°n:</strong> <span id="paymentAmount"></span> VND</p>

  <table id="productTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>T√™n h√†ng</th>
        <th>SL</th>
        <th>ƒê∆°n gi√°</th>
        <th>Th√†nh ti·ªÅn</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="total-row">
        <td colspan="2">T·ªîNG C·ªòNG</td>
        <td id="totalQty"></td>
        <td></td>
        <td id="totalPrice"></td>
      </tr>
    </tfoot>
  </table>

  <div class="qrcode-box">
    <h3>QR Code Thanh to√°n</h3>
    <img id="qrcode" alt="QR Thanh to√°n" width="120" height="120">
  </div>

  <div class="footer" id="datetime"></div>
  <div class="footer">Xin c·∫£m ∆°n Qu√Ω kh√°ch! H·∫πn g·∫∑p l·∫°i.</div>

  <script>
    const params = new URLSearchParams(window.location.search);

    document.getElementById("storeName").textContent = params.get("tencuahang") || "C·ª≠a h√†ng ch∆∞a ƒë·∫∑t t√™n";
    document.getElementById("storeAddress").textContent = "ƒê·ªãa ch·ªâ: " + (params.get("diachicuahang") || "");
    document.getElementById("storePhone").textContent = "SƒêT: " + (params.get("dienthoaicuahang") || "");
    document.getElementById("orderId").textContent = params.get("id") || "";

    document.getElementById("customerName").textContent = params.get("ten") || "";
    document.getElementById("customerAddress").textContent = params.get("diachi") || "";
    document.getElementById("paymentAmount").textContent = params.get("thanhtoan") || "0";

    // Barcode cho m√£ ƒë∆°n h√†ng
    const orderId = params.get("id") || "";
    document.getElementById("barcode").src = "https://barcode.tec-it.com/barcode.ashx?code=Code128&data=" + orderId;

    // Parse danh s√°ch s·∫£n ph·∫©m
    const data = (params.get("data") || "").split("_n_");
    let tbody = document.querySelector("#productTable tbody");
    let totalQty = 0, totalPrice = 0;
    data.forEach((row, index) => {
      if (!row.trim()) return;
      const parts = row.split("|");
      const name = parts[1] || "";
      const qty = parseInt(parts[3] || 0);
      const price = parseFloat(parts[4] || 0);
      const amount = parseFloat(parts[5] || 0);

      totalQty += qty;
      totalPrice += amount;

      let tr = document.createElement("tr");
      tr.innerHTML = `<td>${index + 1}</td><td>${name}</td><td>${qty}</td><td>${price}</td><td>${amount}</td>`;
      tbody.appendChild(tr);
    });
    document.getElementById("totalQty").textContent = totalQty;
    document.getElementById("totalPrice").textContent = totalPrice;

    // QR code thanh to√°n (VietQR API)
    const bank = params.get("bank");
    const stk = params.get("stk");
    const chutk = params.get("chutk");
    const thanhtoan = params.get("thanhtoan");
    if (bank && stk && chutk && thanhtoan) {
      document.getElementById("qrcode").src =
        `https://img.vietqr.io/image/${bank}-${stk}-compact2.jpg?amount=${thanhtoan}&addInfo=${orderId}&accountName=${chutk}`;
    }

    // Th√™m ng√†y gi·ªù in
    document.getElementById("datetime").textContent = "Ng√†y in: " + new Date().toLocaleString("vi-VN");
  </script>
</body>
</html>
