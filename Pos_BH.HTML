<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>H√≥a ƒë∆°n b√°n h√†ng</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 12px; background:#f9f9f9; }
    .invoice { max-width:900px; margin:auto; background:#fff; padding:18px; border:1px solid #ddd; border-radius:6px; }
    h1{ text-align:center; margin:6px 0 10px; }
    .info p{ margin:3px 0; }
    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th, td{ border:1px solid #ccc; padding:8px; vertical-align:middle; }
    th{ background:#efefef; text-align:center; }
    td.num { text-align:right; white-space:nowrap; }
    .total{ text-align:right; font-weight:700; margin-top:8px; }
    @media print{ button{display:none;} body{background:#fff;} }
  </style>
</head>
<body>
  <div class="invoice">
    <h1>üßæ H√ìA ƒê∆†N B√ÅN H√ÄNG</h1>
    <div class="info">
      <p><strong>M√£ ƒë∆°n h√†ng:</strong> <span id="id"></span></p>
      <p><strong>T√™n kh√°ch h√†ng:</strong> <span id="ten"></span></p>
      <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="diachi"></span></p>
      <p><strong>S·ªë l∆∞·ª£ng:</strong> <span id="soluong"></span></p>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:12%;">M√£ SP</th>
          <th style="width:46%;">S·∫£n ph·∫©m</th>
          <th style="width:10%;">S·ªë l∆∞·ª£ng</th>
          <th style="width:16%;">ƒê∆°n gi√°</th>
          <th style="width:16%;">Th√†nh ti·ªÅn</th>
        </tr>
      </thead>
      <tbody id="product-list"></tbody>
    </table>

    <p class="total">T·ªïng ti·ªÅn: <span id="tongtien"></span> ƒë</p>
    <button onclick="window.print()">üñ® In h√≥a ƒë∆°n</button>
  </div>

  <script>
    function formatNumber(v){
      if(v === undefined || v === null || v === "") return "";
      // lo·∫°i b·ªè d·∫•u v√† chuy·ªÉn v·ªÅ s·ªë n·∫øu c√≥
      const n = Number(String(v).replace(/\./g,'').replace(/,/g,''));
      if(isNaN(n)) return v;
      return n.toLocaleString('vi-VN');
    }

    function getQueryParamsAndRender(){
      const params = new URLSearchParams(window.location.search);
      document.getElementById("id").textContent = params.get("id") || "";
      document.getElementById("ten").textContent = decodeURIComponent(params.get("ten") || "");
      document.getElementById("diachi").textContent = decodeURIComponent(params.get("diachi") || "");
      document.getElementById("soluong").textContent = params.get("soluong") || "";

      document.getElementById("tongtien").textContent = formatNumber(params.get("tongtien") || "");

      // L·∫•y data ƒë√£ encode t·ª´ AppSheet
      const raw = params.get("data") || "";
      if(!raw) return;
      // Gi·∫£i m√£ v√† t√°ch c√°c s·∫£n ph·∫©m theo _b_
      const items = decodeURIComponent(raw).split("_b_").filter(x => x.trim() !== "");
      const tbody = document.getElementById("product-list");
      tbody.innerHTML = ""; // clear

      items.forEach(it => {
        // m·ªói item c√≥ c·∫•u tr√∫c: M√£SP||T√™nSP||SL||ƒê∆°nGi√°||Th√†nhTi·ªÅn
        const f = it.split("||");
        const code = f[0] ? f[0].trim() : "";
        const name = f[1] ? f[1].trim() : "";
        const qty = f[2] ? f[2].trim() : "";
        const price = f[3] ? f[3].trim() : "";
        const amount = f[4] ? f[4].trim() : "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${code}</td>
          <td>${name}</td>
          <td class="num">${formatNumber(qty)}</td>
          <td class="num">${formatNumber(price)}</td>
          <td class="num">${formatNumber(amount)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.onload = getQueryParamsAndRender;
  </script>
</body>
</html>
